#!/bin/sh

INSTDIR="$(dirname $0)"
chroot=$(which chroot)
chrootcmd="env -i TERM=$TERM HOME=$HOME SHELL=/bin/bash $chroot $INSTDIR"

if test x"$1" = "xchroot"; then
	echo "# source /etc/profile"
	$chrootcmd /bin/bash
elif test x"$1" = "xsetup"; then
	shift
	$chrootcmd /setup "$@"
elif test x"$1" = "xfetch"; then
	arch=$(uname -m | sed 's/x86_/amd/')
	getpath=$(wget -O- http://${2:-distfiles.gentoo.org}/releases/$arch/autobuilds/latest-stage3.txt | sed '$!d')
	basepath=$(basename $getpath)
	wget http://${2:-distfiles.gentoo.org}/releases/$arch/autobuilds/$getpath
else
	mountpoint -q "$INSTDIR"/proc || mount -t proc proc "$INSTDIR"/proc
	mountpoint -q "$INSTDIR"/dev || mount --rbind /dev "$INSTDIR"/dev
	mountpoint -q "$INSTDIR"/sys || mount --rbind /sys "$INSTDIR"/sys

	cmp -s /etc/resolv.conf "$INSTDIR/etc/resolv.conf" || cp -L /etc/resolv.conf $INSTDIR/etc

	echo "# $chrootcmd /bin/bash"
fi

